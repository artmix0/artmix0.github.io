name: Scrapuj stronę z JS

on:
  schedule:
    - cron: "0 6 * * *"  # codziennie o 6:00 rano
  workflow_dispatch:      # możliwość ręcznego uruchomienia

permissions:
  contents: write

jobs:
  scrape:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Użyj Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Zainstaluj Puppeteer oraz fs
        run: npm install puppeteer fs

      - name: Scrapuj stronę
        run: |
          node <<'EOF'
          import puppeteer from "puppeteer";
          import fs from "fs";
      
          const url = "https://www.zsk.poznan.pl/plany_lekcji/2025";
      
          const run = async () => {
            const browser = await puppeteer.launch({
              args: ['--no-sandbox', '--disable-setuid-sandbox']
            });
            const page = await browser.newPage();
            await page.goto(url, { waitUntil: 'networkidle0' });

            // Pobierz wszystkie linki z menu (Odnośniki do klas i nauczycieli)
            const links = await page.evaluate(() => {
              return Array.from(document.querySelectorAll(".el")) // 
                .map(a => ({ text: a.textContent.trim(), href: a.href }));
            });

            const allPlans = {};

            // Przechodzimy po każdym linku
            for (const link of links) {
              console.log("Przetwarzam:", link.text);
              await page.goto(link.href, { waitUntil: 'networkidle0' });

              // Poczekaj na wyrenderowanie ramki planu
              await new Promise(r => setTimeout(r, 3000)); // 3s, można zwiększyć jeśli potrzebne

              const planFrame = page.frames().find(f => f.name() === 'plan');

              if (planFrame) {
                const planHTML = await planFrame.evaluate(() => document.body.innerHTML);
                allPlans[link.text] = planHTML;
              } else {
                allPlans[link.text] = null;
                console.log("Nie znaleziono ramki planu dla", link.text);
              }
            }

            fs.writeFileSync("allPlans.json", JSON.stringify(allPlans, null, 2));
            console.log("Zapisano wszystkie plany w allPlans.json");

            await browser.close();
          };
      
          run();
          EOF

      - name: Commit i push zmian
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add scraped.json
          git commit -m "Automatyczna aktualizacja danych" || echo "Brak zmian"
          git push
